{% extends "base.html" %}

{% block title %}Personaliza tu cuestionario diario{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-4">
        <h1 class="fw-bold" style="font-size:2rem;">Personaliza tu cuestionario diario</h1>
        <div class="text-muted" style="font-size:1.1rem;">
            Crea nuevas preguntas, organiza las existentes por categorías y gestiona su estado (activas o inactivas) sin necesidad de eliminarlas.
        </div>
    </div>
    <div class="card shadow-sm rounded-4 mx-auto" style="max-width:750px; min-height:600px;">
        <div class="card-body p-4">
            <div class="mb-3">
                <span class="fw-semibold" style="font-size:1.2rem;">Preguntas</span>
            </div>
            <!-- Tabs de filtro -->
            <div class="mb-4">
                <div class="btn-group" role="group" aria-label="Filtros de categoría">
                    <button type="button" class="btn btn-outline-primary active" data-category="Todas">Todas</button>
                    {% for cat in categories if cat != 'Todas' %}
                    <button type="button" class="btn btn-outline-primary" data-category="{{ cat }}">{{ cat }}</button>
                    {% endfor %}
                </div>
            </div>
            <!-- Lista de preguntas -->
            <div id="preguntas-lista">
                {% for question in questions %}
                <div class="d-flex align-items-center justify-content-between py-3 border-bottom pregunta-item" data-category="{{ question.categoria }}">
                    <div>
                        <div class="fw-semibold" style="font-size:1.1rem;">{{ question.text }}</div>
                        <div class="text-muted small">{{ question.categoria }}</div>
                        {% if question.descripcion %}
                        <div class="text-muted small mt-1">{{ question.descripcion }}</div>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center gap-4">
                        <div class="text-center">
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input toggle-status" type="checkbox" data-question-id="{{ question.id }}" {% if question.active %}checked{% endif %}>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-sm btn-outline-primary edit-question mb-1" 
                                data-id="{{ question.id }}"
                                data-text="{{ question.text|e }}"
                                data-descripcion="{{ question.descripcion|e }}"
                                data-type="{{ question.type }}"
                                data-categoria="{{ question.categoria }}"
                                data-is_required="{{ question.is_required }}"
                                data-active="{{ question.active }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-sm btn-outline-danger delete-question mb-1" data-id="{{ question.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-question-circle display-4 mb-3"></i>
                    <h5>No hay preguntas aún</h5>
                    <p>Comienza creando tu primera pregunta</p>
                </div>
                {% endfor %}
            </div>
            <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#nuevaPreguntaModal">
                    <i class="bi bi-plus-lg me-2"></i>Añadir pregunta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Pregunta -->
<div class="modal fade" id="nuevaPreguntaModal" tabindex="-1" aria-labelledby="nuevaPreguntaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <form id="add-question-form">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="nuevaPreguntaModalLabel">Nueva Pregunta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="mb-2 text-muted" style="font-size:1rem;">
            Completa los campos para crear una nueva pregunta.
          </div>
          <div class="mb-3">
            <label for="text" class="form-label fw-semibold">Pregunta</label>
            <textarea class="form-control" id="text" name="text" rows="3" placeholder="Escribe la pregunta aquí..." required></textarea>
          </div>
          <div class="mb-3">
            <label for="descripcion" class="form-label">Descripción (opcional)</label>
            <textarea class="form-control" id="descripcion" name="descripcion" rows="2" placeholder="Añade una descripción o instrucciones adicionales..."></textarea>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="type" class="form-label">Tipo de Pregunta</label>
              <select class="form-select" id="type" name="type" onchange="toggleOptionsField()" required>
                <option value="select">Sí/No</option>
                <option value="text">Texto Libre</option>
                <option value="checkbox">Selección Múltiple</option>
                <option value="radio">Opción Única</option>
              </select>
            </div>
            <div class="col-6">
              <label for="categoria-select" class="form-label">Categoría Existente</label>
              <select class="form-select" id="categoria-select" name="categoria_existente">
                {% for cat in categories if cat != 'Todas' %}
                <option value="{{ cat }}" {% if cat == 'General' %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="nueva-categoria-input" class="form-label">O Añadir Nueva Categoría</label>
            <input type="text" class="form-control" id="nueva-categoria-input" name="nueva_categoria" placeholder="Escribe un nombre para una nueva categoría (opcional)">
          </div>
          <div class="mb-3" id="options-container" style="display: none;">
            <label for="options" class="form-label">Opciones (una por línea, con guion al inicio)</label>
            <textarea class="form-control" id="options" name="options" rows="3" placeholder="- Opción 1
- Opción 2
- Opción 3"></textarea>
            <div class="form-text">Escribe cada opción en una línea separada, comenzando con un guion medio (-) y un espacio. Ejemplo: "- Manzana" (sin comillas).</div>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="is_required" name="is_required">
            <label class="form-check-label" for="is_required">¿Es obligatorio responder esta pregunta?</label>
          </div>
          <script>
          function toggleOptionsField() {
            const typeSelect = document.getElementById('type');
            const optionsContainer = document.getElementById('options-container');
            
            if (typeSelect.value === 'checkbox' || typeSelect.value === 'radio') {
              optionsContainer.style.display = 'block';
            } else {
              optionsContainer.style.display = 'none';
            }
          }
          
          // Inicializar el estado al cargar la página
          document.addEventListener('DOMContentLoaded', function() {
            toggleOptionsField();
            
            // Manejar el envío del formulario
            const form = document.getElementById('add-question-form');
            if (form) {
              form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Mostrar mensaje de carga
                const submitBtn = document.getElementById('submit-question');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
                
                // Obtener los datos del formulario
                const formData = new FormData(form);
                const data = {
                    text: formData.get('text') || '',
                    type: formData.get('type') || 'text',
                    options: formData.get('options') || '',
                    descripcion: formData.get('descripcion') || '',
                    is_required: document.getElementById('is_required').checked,
                    active: document.getElementById('active').checked,
                    categoria_existente: formData.get('categoria_existente') || 'General',
                    nueva_categoria: formData.get('nueva_categoria') || ''
                };
                
                console.log('Datos a enviar:', data);
                
                // Procesar opciones si es necesario
                if (data.type === 'checkbox' || data.type === 'radio') {
                  if (!data.options || data.options.trim() === '') {
                    showError('Por favor ingresa al menos una opción para este tipo de pregunta.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                  }
                }
                
                // Mostrar datos que se enviarán
                console.log('Enviando datos al servidor:', data);
                
                // Enviar datos al servidor
                fetch("{{ url_for('add_question') }}", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                  },
                  credentials: 'same-origin',
                  body: JSON.stringify(data)
                })
                .then(async response => {
                  console.log('Estado de la respuesta:', response.status);
                  const contentType = response.headers.get('content-type');
                  console.log('Tipo de contenido de la respuesta:', contentType);
                  
                  // Intentar analizar la respuesta como JSON
                  try {
                    const responseData = await response.json();
                    console.log('Datos de la respuesta:', responseData);
                    
                    if (!response.ok) {
                      throw new Error(responseData.message || 'Error en la petición');
                    }
                    
                    return responseData;
                  } catch (jsonError) {
                    // Si no se puede analizar como JSON, obtener el texto de la respuesta
                    const text = await response.text();
                    console.error('Error al analizar la respuesta JSON. Texto de respuesta:', text);
                    throw new Error(`Error en el servidor: ${response.status} - ${text.substring(0, 200)}`);
                  }
                })
                .then(data => {
                  console.log('Datos de respuesta:', data);
                  if (data.status === 'success') {
                    // Cerrar el modal y recargar la página
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nuevaPreguntaModal'));
                    if (modal) {
                      modal.hide();
                    }
                    location.reload();
                  } else {
                    throw new Error(data.message || 'Error al guardar la pregunta');
                  }
                })
                .catch(error => {
                  console.error('Error en la petición:', error);
                  showError(error.message || 'Error al conectar con el servidor');
                })
                .finally(() => {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalBtnText;
                });
              });
            }
            
            function showError(message) {
              const errorDiv = document.getElementById('form-error');
              errorDiv.textContent = message;
              errorDiv.style.display = 'block';
              setTimeout(() => {
                errorDiv.style.display = 'none';
              }, 5000);
            }
          });
          </script>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="active" name="active" checked>
            <label class="form-check-label" for="active">¿La pregunta está activa para los usuarios?</label>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="submit-question">Crear Pregunta</button>
          <div id="form-error" class="text-danger mt-2" style="display: none;"></div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Editar Pregunta -->
<div class="modal fade" id="editarPreguntaModal" tabindex="-1" aria-labelledby="editarPreguntaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <form id="edit-question-form">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="editarPreguntaModalLabel">Editar Pregunta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="mb-2 text-muted" style="font-size:1rem;">
            Modifica los campos que desees y guarda los cambios.
          </div>
          <input type="hidden" id="edit-id" name="id">
          <div class="mb-3">
            <label for="edit-text" class="form-label fw-semibold">Pregunta</label>
            <input type="text" class="form-control" id="edit-text" name="text" required>
          </div>
          <div class="mb-3">
            <label for="edit-descripcion" class="form-label">Descripción (opcional)</label>
            <textarea class="form-control" id="edit-descripcion" name="descripcion" rows="2"></textarea>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="edit-type" class="form-label">Tipo de Pregunta</label>
              <select class="form-select" id="edit-type" name="type" required>
                <option value="select">Sí/No</option>
                <option value="text">Texto Libre</option>
                <option value="checkbox">Casillas de Verificación</option>
                <option value="radio">Botones de Radio</option>
              </select>
            </div>
            <div class="col-6">
              <label for="edit-categoria" class="form-label">Categoría</label>
              <select class="form-select" id="edit-categoria" name="categoria">
                <option value="General">General</option>
                <option value="Salud">Salud</option>
                <option value="Productividad">Productividad</option>
              </select>
            </div>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="edit-is_required" name="is_required">
            <label class="form-check-label" for="edit-is_required">¿Es obligatorio responder esta pregunta?</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="edit-active" name="active">
            <label class="form-check-label" for="edit-active">¿La pregunta está activa para los usuarios?</label>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtro de tabs por categoría (frontend)
document.querySelectorAll('[data-category]').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const cat = this.getAttribute('data-category');
        document.querySelectorAll('.pregunta-item').forEach(item => {
            if (cat === 'Todas' || item.getAttribute('data-category') === cat) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
// Lógica para abrir el modal de edición y precargar datos
const editModal = new bootstrap.Modal(document.getElementById('editarPreguntaModal'));
document.querySelectorAll('.edit-question').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('edit-id').value = this.dataset.id;
        document.getElementById('edit-text').value = this.dataset.text;
        document.getElementById('edit-descripcion').value = this.dataset.descripcion;
        document.getElementById('edit-type').value = this.dataset.type;
        document.getElementById('edit-categoria').value = this.dataset.categoria;
        document.getElementById('edit-is_required').checked = this.dataset.is_required == '1' || this.dataset.is_required == 'true';
        document.getElementById('edit-active').checked = this.dataset.active == '1' || this.dataset.active == 'true';
        editModal.show();
    });
});
// Lógica para enviar la edición por AJAX
const editForm = document.getElementById('edit-question-form');
if (editForm) {
    editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const data = {
            text: document.getElementById('edit-text').value,
            descripcion: document.getElementById('edit-descripcion').value,
            type: document.getElementById('edit-type').value,
            categoria: document.getElementById('edit-categoria').value,
            is_required: document.getElementById('edit-is_required').checked ? 1 : 0,
            active: document.getElementById('edit-active').checked ? 1 : 0
        };
        fetch(`/question/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                location.reload();
            } else {
                alert('Error al guardar los cambios: ' + (res.message || ''));
            }
        })
        .catch(err => alert('Error al guardar los cambios: ' + err));
    });
}
// Lógica para eliminar pregunta por AJAX
document.querySelectorAll('.delete-question').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.id;
        if (confirm('¿Estás seguro de que deseas eliminar esta pregunta? Esta acción no se puede deshacer.')) {
            fetch(`/question/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(res => {
                if (res.status === 'success') {
                    // Quitar de la lista visualmente
                    this.closest('.pregunta-item').remove();
                } else {
                    alert('Error al eliminar: ' + (res.message || ''));
                }
            })
            .catch(err => alert('Error al eliminar: ' + err));
        }
    });
});
</script>
{% endblock %}
